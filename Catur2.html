<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catur Online – Final</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family:sans-serif; text-align:center; background:#121212; color:#fff; margin:0; }
h2 { margin:20px 0; }
input,button { padding:10px; margin:5px; border:none; border-radius:6px; font-size:16px; }
button { cursor:pointer; font-weight:bold; }
#login,#game { max-width:400px; margin:auto; margin-top:20px; }
#game { display:none; }
#board { display:grid; grid-template-columns:repeat(8,1fr); gap:2px; margin:20px auto; width:90vw; max-width:400px; }
.cell { width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size:5vw; user-select:none; }
.light { background:#f0d9b5; color:#000; }
.dark { background:#b58863; color:#000; }
.selected { outline:3px solid red; }
#status { margin:10px; font-weight:bold; }
#chatbox { height:120px; overflow-y:auto; background:#1e1e1e; padding:8px; border-radius:8px; margin:10px 0; text-align:left; }
</style>
</head>
<body>

<h2>Catur Online – Final</h2>

<!-- LOGIN -->
<div id="login">
  <input id="nameInput" placeholder="Nama">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password (min 6)">
  <input id="roomInput" placeholder="Nomor Room (1–10)">
  <br>
  <button id="loginBtn">Masuk / Daftar & Masuk Room</button>
  <div id="loginError" style="color:#ff5252;"></div>
</div>

<!-- GAME -->
<div id="game">
  <div id="status">Menunggu lawan...</div>
  <div id="board"></div>

  <div id="chatbox"></div>
  <input id="chatInput" placeholder="Chat...">
  <button id="sendChat">Kirim</button>

  <button id="leaveBtn" style="background:#ff5252;">Leave Room</button>
  <button id="logoutBtn" style="background:#777;">Logout</button>
</div>

<script>
/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDnQwsg1aKKG38RjrPGoh5593eU6nO7Be4",
  authDomain: "catur2.firebaseapp.com",
  projectId: "catur2",
  storageBucket: "catur2.firebasestorage.app",
  messagingSenderId: "59572057774",
  appId: "1:59572057774:web:1e6426fa435811e8ea5f3f",
  measurementId: "G-QQ1WN6N31S"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

/* ===== DOM ELEMENTS ===== */
const login = document.getElementById("login");
const game = document.getElementById("game");
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");
const messages = document.getElementById("chatbox");
const chatInput = document.getElementById("chatInput");
const loginError = document.getElementById("loginError");

/* ===== STATE ===== */
let uid, myName, roomId, myColor, role='spectator';
let board = [], turn='w', selected=null, gameOver=false;

/* ===== LOGIN ===== */
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("password").value.trim();
  const name = document.getElementById("nameInput").value.trim();
  let room = parseInt(document.getElementById("roomInput").value.trim());
  if(!email||!pass||!name||!room||room<1||room>10){
    loginError.textContent = "Lengkapi semua field dengan benar (Room 1–10)";
    return;
  }
  roomId = "room"+room;

  try {
    const res = await auth.signInWithEmailAndPassword(email, pass);
    afterLogin(res.user, name);
  } catch {
    try{
      const res = await auth.createUserWithEmailAndPassword(email, pass);
      afterLogin(res.user, name);
    } catch(e){
      loginError.textContent = e.message;
    }
  }
};

function afterLogin(user, name){
  uid = user.uid;
  myName = name;
  db.ref("users/"+uid).set({name});
  login.style.display="none";
  game.style.display="block";
  joinRoom();
}

/* ===== JOIN ROOM ===== */
function joinRoom(){
  const roomRef = db.ref("rooms/"+roomId);

  roomRef.once('value', snap=>{
    if(!snap.exists()){
      // buat room baru
      roomRef.set({board:initBoard(), turn:'w', players:{white:uid}, chat:{}});
      myColor='white'; role='player';
    } else {
      const p = snap.val().players || {};
      if(!p.white){roomRef.child("players/white").set(uid); myColor='white'; role='player';}
      else if(!p.black){roomRef.child("players/black").set(uid); myColor='black'; role='player';}
      else role='spectator';
    }
    listenRoom();
    listenChat();
  });
}

/* ===== INIT BOARD ===== */
function initBoard(){
  return [
    "r","n","b","q","k","b","n","r",
    "p","p","p","p","p","p","p","p",
    "","","","","","","","",
    "","","","","","","","",
    "","","","","","","","",
    "","","","","","","","",
    "P","P","P","P","P","P","P","P",
    "R","N","B","Q","K","B","N","R"
  ];
}

/* ===== DRAW BOARD ===== */
function draw(){
  boardEl.innerHTML="";
  board.forEach((p,i)=>{
    const cell = document.createElement("div");
    cell.className = "cell "+((Math.floor(i/8)+i)%2===0?"light":"dark");
    if(i===selected) cell.classList.add("selected");
    cell.innerText = p;
    cell.onclick = ()=>click(i);
    boardEl.appendChild(cell);
  });
  statusEl.textContent = role==='spectator' ? "Penonton" : (turn===myColor?'Giliran kamu':'Giliran lawan');
}

/* ===== CLICK HANDLER ===== */
function click(i){
  if(role!=='player' || gameOver) return;
  if(turn!==myColor) return;

  if(selected===i){ selected=null; draw(); return; }

  if(selected===null){
    if(isMine(board[i])) selected=i;
    draw();
    return;
  }

  move(selected,i);
  selected=null;
  draw();
}

function isMine(p){
  if(!p) return false;
  return myColor==='white'?p===p.toUpperCase():p===p.toLowerCase();
}

/* ===== VALID MOVE ===== */
function sameColor(a,b){
  if(!a||!b) return false;
  return (a===a.toUpperCase()) === (b===b.toUpperCase());
}

function validPawn(f,t){
  const p=board[f];
  const dir=p==="P"?-8:8;
  const start=p==="P"?6:1;
  if(t===f+dir && board[t]==="") return true;
  if(Math.floor(f/8)===start && t===f+dir*2 && board[f+dir]==="" && board[t]==="") return true;
  if((t===f+dir-1 || t===f+dir+1) && board[t]!="" && !sameColor(p,board[t])) return true;
  return false;
}

function validRook(f,t){ if((t-f)%8===0) return clearPath(f,t,(t>f?8:-8)); if(Math.floor(f/8)===Math.floor(t/8)) return clearPath(f,t,(t>f?1:-1)); return false; }
function validBishop(f,t){ if(Math.abs(t-f)%9===0) return clearPath(f,t,(t>f?9:-9)); if(Math.abs(t-f)%7===0) return clearPath(f,t,(t>f?7:-7)); return false; }
function validKnight(f,t){ return [6,10,15,17].includes(Math.abs(t-f)); }
function validQueen(f,t){ return validRook(f,t)||validBishop(f,t); }
function validKing(f,t){ return [1,7,8,9].includes(Math.abs(t-f)); }

function clearPath(f,t,step){ for(let i=f+step;i!==t;i+=step) if(board[i]!=="") return false; return true; }

/* ===== MOVE ===== */
function move(f,t){
  const piece = board[f];
  if(piece==="") return;
  let ok=false;
  const tp = piece.toLowerCase();
  if(tp==='p') ok=validPawn(f,t);
  else if(tp==='r') ok=validRook(f,t);
  else if(tp==='n') ok=validKnight(f,t);
  else if(tp==='b') ok=validBishop(f,t);
  else if(tp==='q') ok=validQueen(f,t);
  else if(tp==='k') ok=validKing(f,t);
  if(ok && sameColor(piece,board[t])) ok=false;
  if(!ok) return;

  const nb = [...board];
  nb[t]=piece; nb[f]="";
  // promotion
  if(piece==="P" && t<8) nb[t]="Q";
  if(piece==="p" && t>55) nb[t]="q";

  // update Firebase
  db.ref("rooms/"+roomId).update({board:nb, turn:turn==='w'?'b':'w'});
}

/* ===== LISTEN ROOM ===== */
function listenRoom(){
  db.ref("rooms/"+roomId).on('value', snap=>{
    if(!snap.exists()) return;
    const d = snap.val();
    board = d.board || initBoard();
    turn = d.turn==='w'?'w':'b';
    draw();
  });
}

/* ===== CHAT ===== */
document.getElementById("sendChat").onclick = ()=>{
  const txt = chatInput.value.trim();
  if(!txt) return;
  db.ref("rooms/"+roomId+"/chat").push({user:myName,text:txt,time:Date.now()});
  chatInput.value="";
};

function listenChat(){
  db.ref("rooms/"+roomId+"/chat").limitToLast(50).on("child_added",snap=>{
    const m = snap.val();
    messages.innerHTML += `<b>${m.user}:</b> ${m.text}<br>`;
    messages.scrollTop = messages.scrollHeight;
  });
}

/* ===== LOGOUT & LEAVE ===== */
document.getElementById("leaveBtn").onclick = ()=>{
  if(myColor) db.ref("rooms/"+roomId+"/players/"+myColor).remove();
  location.reload();
};
document.getElementById("logoutBtn").onclick = ()=>{auth.signOut(); location.reload();}
</script>
</body>
</html>