<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catur Online – Realtime</title>
<style>
body { font-family:sans-serif; text-align:center; background:#121212; color:#fff; }
h2 { margin-top:20px; }
input,button { padding:10px; margin:5px; border-radius:6px; border:none; }
button { background:#2ecc71; color:#000; font-weight:bold; }
#login,#game { max-width:400px; margin:auto; }
#game { display:none; }
#board { display:grid; grid-template-columns:repeat(8,1fr); gap:2px; margin:10px auto; width:90vw; max-width:360px; }
.cell { width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size:6vw; user-select:none; }
.light { background:#f0d9b5; }
.dark { background:#b58863; }
.selected { outline:3px solid red; }
#status { margin:8px; font-weight:bold; }
#chatbox { height:120px; overflow-y:auto; text-align:left; background:#111; padding:5px; margin-bottom:5px; }
</style>
</head>
<body>

<h2>Catur Online – Realtime</h2>

<div id="login">
  <input id="nameInput" placeholder="Nama">
  <input id="roomInput" placeholder="Nomor Room (1-10)">
  <button id="joinBtn">Masuk Room</button>
  <div id="loginError" style="color:red;"></div>
</div>

<div id="game">
  <div id="status">Menunggu lawan...</div>
  <div id="board"></div>
  <div id="chatbox"></div>
  <input id="chatInput" placeholder="Chat..."><button id="sendChat">Kirim</button>
  <br><button id="leaveBtn" style="background:#ff5252">Leave Room</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyDnQwsg1aKKG38RjrPGoh5593eU6nO7Be4",
  authDomain: "catur2.firebaseapp.com",
  databaseURL: "https://catur2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "catur2",
  storageBucket: "catur2.appspot.com",
  messagingSenderId: "59572057774",
  appId: "1:59572057774:web:1e6426fa435811e8ea5f3f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Global =====
let uid = Date.now().toString(36); // unik tapi sederhana
let myName="", roomId="", myColor="", role="spectator";
let board=[], turn="w", selected=null;

// DOM
const loginDiv=document.getElementById("login");
const gameDiv=document.getElementById("game");
const boardEl=document.getElementById("board");
const statusEl=document.getElementById("status");
const chatBox=document.getElementById("chatbox");
const chatInput=document.getElementById("chatInput");
const loginError=document.getElementById("loginError");

// ===== Init Board =====
function initBoard(){
  return [
    "r","n","b","q","k","b","n","r",
    "p","p","p","p","p","p","p","p",
    "","","","","","","","",
    "","","","","","","","",
    "","","","","","","","",
    "","","","","","","","",
    "P","P","P","P","P","P","P","P",
    "R","N","B","Q","K","B","N","R"
  ];
}

// ===== Draw Board =====
function draw(){
  boardEl.innerHTML="";
  board.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="cell "+(((i+Math.floor(i/8))%2===0)?"light":"dark");
    if(i===selected) d.classList.add("selected");
    d.innerText = p;
    d.onclick = ()=>click(i);
    boardEl.appendChild(d);
  });

  if(role==="spectator") statusEl.innerText="Penonton";
  else statusEl.innerText = turn===myColor?"Giliran kamu":"Giliran lawan";
}

// ===== Player Validation =====
function isMine(p){ 
  if(!p) return false;
  return myColor==="w"?p===p.toUpperCase():p===p.toLowerCase();
}

// ===== Move Rules (Pawn Only for simplicity) =====
function validPawn(f,t){
  const p = board[f];
  const dir = p==="P"?-8:8;
  const start = p==="P"?6:1;
  if(t===f+dir && board[t]==="") return true;
  if(Math.floor(f/8)===start && t===f+dir*2 && board[f+dir]==="" && board[t]==="") return true;
  if((t===f+dir-1 || t===f+dir+1) && board[t]!="" && !sameColor(p,board[t])) return true;
  return false;
}

function sameColor(a,b){ 
  if(!a||!b) return false;
  return (a===a.toUpperCase()) === (b===b.toUpperCase());
}

// ===== Click Handler =====
function click(i){
  if(role!=="player"||turn!==myColor) return;

  if(selected===null){
    if(isMine(board[i])) selected=i;
  }else{
    move(selected,i);
    selected=null;
    draw();
  }
}

// ===== Move =====
function move(f,t){
  const piece=board[f];
  if(piece.toLowerCase()==="p" && !validPawn(f,t)) return;
  if(isMine(board[t])) return;
  const nb=[...board];
  nb[t]=piece; nb[f]="";
  board=nb;
  turn = turn==="w"?"b":"w";
  db.ref("rooms/"+roomId).update({board,turn});
}

// ===== Join Room =====
document.getElementById("joinBtn").onclick = ()=>{
  myName=document.getElementById("nameInput").value.trim();
  roomId=document.getElementById("roomInput").value.trim();

  if(!myName||!roomId||isNaN(roomId)||roomId<1||roomId>10){
    loginError.innerText="Nama atau nomor room salah (1-10)";
    return;
  }

  const roomRef = db.ref("rooms/"+roomId);
  roomRef.once("value",snap=>{
    let data = snap.val();
    if(!data){
      // buat room baru
      roomRef.set({board:initBoard(), turn:"w", players:{w:uid}});
      myColor="w"; role="player";
    }else{
      const p=data.players||{};
      if(!p.w){ roomRef.child("players/w").set(uid); myColor="w"; role="player"; }
      else if(!p.b){ roomRef.child("players/b").set(uid); myColor="b"; role="player"; }
      else role="spectator";
    }
    loginDiv.style.display="none";
    gameDiv.style.display="block";
    listenRoom();
    listenChat();
  });
};

// ===== Listen Room =====
function listenRoom(){
  db.ref("rooms/"+roomId).on("value",snap=>{
    const data = snap.val();
    if(!data) return;
    board = data.board || initBoard();
    turn = data.turn || "w";
    draw();
  });
}

// ===== Chat =====
document.getElementById("sendChat").onclick = ()=>{
  const t = chatInput.value.trim();
  if(!t) return;
  db.ref("rooms/"+roomId+"/chat").push({user:myName,text:t,time:Date.now()});
  chatInput.value="";
};

function listenChat(){
  db.ref("rooms/"+roomId+"/chat").limitToLast(50)
    .on("child_added",snap=>{
      const m=snap.val();
      const div=document.createElement("div");
      div.innerText=`${m.user}: ${m.text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
}

// ===== Leave Room =====
document.getElementById("leaveBtn").onclick = ()=>{
  if(myColor) db.ref("rooms/"+roomId+"/players/"+myColor).remove();
  location.reload();
};
</script>

</body>
</html>