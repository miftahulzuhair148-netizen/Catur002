<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catur Online â€“ Room Pilihan</title>
<style>
  body { font-family:sans-serif; text-align:center; background:#121212; color:#fff; }
  h1 { margin-top:20px; }
  #login, #roomSelect, #game { max-width:400px; margin:20px auto; }
  input, button { padding:10px; margin:5px; border:none; border-radius:6px; font-size:16px; }
  button { cursor:pointer; font-weight:bold; }
  #board { display:grid; grid-template-columns:repeat(8,1fr); gap:2px; margin:20px auto; width:320px; }
  .cell { width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:24px; user-select:none; }
  .white { background:#eee; color:#000; }
  .black { background:#666; color:#fff; }
  .selected { outline:2px solid #ff5252; }
  #status { margin:10px; font-weight:bold; }
  #chatbox { width:100%; max-width:400px; height:120px; overflow-y:auto; background:#1e1e1e; margin:10px auto; padding:5px; text-align:left; }
</style>
</head>
<body>

<h1>Catur Online</h1>

<!-- LOGIN -->
<div id="login">
  <input id="nameInput" placeholder="Nama">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <br>
  <button id="loginBtn">Masuk / Daftar</button>
  <div id="loginError" style="color:red"></div>
</div>

<!-- PILIH ROOM -->
<div id="roomSelect" style="display:none">
  <h3>Pilih Room</h3>
  <div id="rooms"></div>
</div>

<!-- GAME -->
<div id="game" style="display:none">
  <div id="status">Menunggu lawan...</div>
  <div id="board"></div>
  <div id="chatbox"></div>
  <input id="chatInput" placeholder="Chat..." style="width:60%">
  <button id="sendChat">Kirim</button>
  <br>
  <button id="leaveRoom" style="background:#ff5252;">Keluar Room</button>
  <button id="logout" style="background:#777;">Logout</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDnQwsg1aKKG38RjrPGoh5593eU6nO7Be4",
  authDomain: "catur2.firebaseapp.com",
  databaseURL:"https://catur2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "catur2",
  storageBucket: "catur2.appspot.com",
  messagingSenderId: "59572057774",
  appId: "1:59572057774:web:1e6426fa435811e8ea5f3f",
  measurementId: "G-QQ1WN6N31S"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ===== GLOBAL ===== */
let uid, myName, roomId, myColor, role="spectator";
let board=[], turn="w", selected=null;

/* ===== DOM ===== */
const loginDiv = document.getElementById("login");
const roomDiv = document.getElementById("roomSelect");
const gameDiv = document.getElementById("game");
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");
const chatbox = document.getElementById("chatbox");
const chatInput = document.getElementById("chatInput");
const roomsEl = document.getElementById("rooms");
const loginError = document.getElementById("loginError");

/* ===== LOGIN ===== */
document.getElementById("loginBtn").onclick = async ()=>{
  const email = document.getElementById("email").value.trim();
  const pass  = document.getElementById("password").value.trim();
  myName = document.getElementById("nameInput").value.trim() || "User";
  if(!email || !pass) { loginError.textContent="Lengkapi semua field"; return; }

  try {
    const res = await auth.signInWithEmailAndPassword(email, pass);
    afterLogin(res.user);
  } catch {
    try {
      const res = await auth.createUserWithEmailAndPassword(email, pass);
      afterLogin(res.user);
    } catch(e){ loginError.textContent=e.message; }
  }
};

function afterLogin(user){
  uid = user.uid;
  db.ref("users/"+uid).set({name:myName});
  loginDiv.style.display="none";
  showRoomSelection();
}

/* ===== ROOM SELECTION ===== */
function showRoomSelection(){
  roomDiv.style.display="block";
  roomsEl.innerHTML = "";
  for(let i=1;i<=10;i++){
    const btn = document.createElement("button");
    btn.textContent = "Room "+i;
    btn.onclick = ()=>joinRoom(i);
    roomsEl.appendChild(btn);
  }
}

async function joinRoom(num){
  roomId = "room"+num;
  roomDiv.style.display="none";
  gameDiv.style.display="block";

  const roomRef = db.ref("rooms/"+roomId);
  const snap = await roomRef.once("value");
  const data = snap.val() || {board:initBoard(), turn:"w", players:{}};

  if(!data.players.white){ myColor="w"; role="player"; data.players.white=uid; }
  else if(!data.players.black){ myColor="b"; role="player"; data.players.black=uid; }
  else { myColor=null; role="spectator"; }

  await roomRef.set(data);

  listenRoom();
  listenChat();
}

/* ===== BOARD ===== */
function initBoard(){
  return [
    ["r","n","b","q","k","b","n","r"],
    ["p","p","p","p","p","p","p","p"],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["","","","","","","",""],
    ["P","P","P","P","P","P","P","P"],
    ["R","N","B","Q","K","B","N","R"]
  ];
}

function drawBoard(){
  boardEl.innerHTML = "";
  board.forEach((row,r)=>{
    row.forEach((p,c)=>{
      const cell = document.createElement("div");
      const isBlack = (r+c)%2===1;
      cell.className = "cell "+(isBlack?"black":"white");
      cell.textContent = p;
      if(selected && selected[0]===r && selected[1]===c) cell.classList.add("selected");
      cell.onclick = ()=>clickCell(r,c);
      boardEl.appendChild(cell);
    });
  });
  updateStatus();
}

function clickCell(r,c){
  if(role!=="player" || gameOver) return;
  if(!selected){
    if(board[r][c] && ((myColor==="w" && board[r][c]===board[r][c].toUpperCase()) || (myColor==="b" && board[r][c]===board[r][c].toLowerCase())) ){
      selected=[r,c];
    }
  } else {
    move(selected,[r,c]);
    selected=null;
  }
  drawBoard();
}

function move(from,to){
  const [fr,fc] = from, [tr,tc] = to;
  board[tr][tc]=board[fr][fc]; board[fr][fc]="";
  turn = turn==="w"?"b":"w";
  db.ref("rooms/"+roomId+"/board").set(board);
  db.ref("rooms/"+roomId+"/turn").set(turn);
}

/* ===== LISTEN ROOM ===== */
function listenRoom(){
  db.ref("rooms/"+roomId).on("value",snap=>{
    const data = snap.val();
    if(!data) return;
    board = data.board;
    turn = data.turn;
    drawBoard();
  });
}

/* ===== CHAT ===== */
document.getElementById("sendChat").onclick = ()=>{
  if(!chatInput.value) return;
  const msg = {user:myName, text:chatInput.value, time:Date.now()};
  db.ref("rooms/"+roomId+"/chat").push(msg);
  chatInput.value="";
}

function listenChat(){
  db.ref("rooms/"+roomId+"/chat").limitToLast(50).on("child_added",snap=>{
    const m = snap.val();
    chatbox.innerHTML += `<b>${m.user}:</b> ${m.text}<br>`;
    chatbox.scrollTop = chatbox.scrollHeight;
  });
}

/* ===== STATUS ===== */
function updateStatus(){
  if(role==="spectator") statusEl.textContent = "Penonton, giliran "+(turn==="w"?"Putih":"Hitam");
  else statusEl.textContent = "Kamu: "+(myColor==="w"?"Putih":"Hitam")+", giliran "+(turn==="w"?"Putih":"Hitam");
}

/* ===== EXIT ===== */
document.getElementById("leaveRoom").onclick = ()=>{
  if(myColor) db.ref("rooms/"+roomId+"/players/"+(myColor==="w"?"white":"black")).remove();
  gameDiv.style.display="none";
  showRoomSelection();
}

document.getElementById("logout").onclick = ()=>{
  auth.signOut().then(()=>location.reload());
}
</script>
</body>
</html>