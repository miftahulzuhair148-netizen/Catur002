<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catur Online â€“ Full Chess</title>
<style>
body { font-family:sans-serif; text-align:center; background:#121212; color:#fff; margin:0; }
h2 { margin-top:20px; }
input, button { padding:8px; margin:4px; border-radius:6px; border:none; font-size:14px; }
button { background:#2ecc71; color:#000; font-weight:bold; cursor:pointer; }
#board { display:grid; grid-template-columns:repeat(8,1fr); gap:2px; margin:20px auto; width:90vw; max-width:400px; }
.cell { width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size:5vw; user-select:none; }
.light { background:#f0d9b5; color:#000; }
.dark { background:#b58863; color:#000; }
.selected { outline:3px solid #ff5252; }
#status { margin:10px; font-weight:bold; }
#chatbox { max-width:400px; margin:10px auto; height:140px; overflow-y:auto; background:#1e1e1e; padding:6px; text-align:left; }
#chatinput { width:70%; padding:6px; }
#errorMsg { color:#ff5252; margin:6px; }
</style>
</head>
<body>

<h2>Catur Online</h2>

<div id="login">
<input id="nameInput" placeholder="Nama">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password minimal 6">
<br>
<button id="loginBtn">Masuk / Daftar</button>
<div id="errorMsg"></div>
</div>

<div id="game" style="display:none;">
<div id="status">Menunggu lawan...</div>
<div id="board"></div>

<div id="chatbox"></div>
<input id="chatinput" placeholder="Chat..." /><button id="sendChat">Kirim</button>
<br>
<button id="logoutBtn" style="background:#ff5252;">Logout</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ====== FIREBASE CONFIG ======
const firebaseConfig = {
  apiKey: "AIzaSyDnQwsg1aKKG38RjrPGoh5593eU6nO7Be4",
  authDomain: "catur2.firebaseapp.com",
  databaseURL: "https://catur2-default-rtdb.firebaseio.com",
  projectId: "catur2",
  storageBucket: "catur2.appspot.com",
  messagingSenderId: "59572057774",
  appId: "1:59572057774:web:1e6426fa435811e8ea5f3f",
  measurementId: "G-QQ1WN6N31S"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ====== GLOBAL ======
let uid, myName, roomId, myColor='spectator';
let board=[], turn='w', selected=null;

// DOM
const loginDiv=document.getElementById('login');
const gameDiv=document.getElementById('game');
const boardEl=document.getElementById('board');
const statusEl=document.getElementById('status');
const chatbox=document.getElementById('chatbox');
const chatInput=document.getElementById('chatinput');
const errorMsg=document.getElementById('errorMsg');

// ====== LOGIN ======
document.getElementById('loginBtn').onclick = async ()=>{
    const name = document.getElementById('nameInput').value.trim();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    if(!name || !email || pass.length<6){ errorMsg.innerText='Isi semua field dengan benar'; return; }
    try {
        const res = await auth.signInWithEmailAndPassword(email,pass);
        afterLogin(res.user,name);
    } catch {
        try {
            const res = await auth.createUserWithEmailAndPassword(email,pass);
            afterLogin(res.user,name);
        } catch(e){ errorMsg.innerText=e.message; }
    }
};

function afterLogin(user,name){
    uid = user.uid; myName = name;
    db.ref('users/'+uid).set({name});
    loginDiv.style.display='none';
    gameDiv.style.display='block';
    joinRoom();
}

// ====== ROOM ======
function joinRoom(){
    let roomNum = prompt('Masukkan nomor room (1-10):');
    roomNum = parseInt(roomNum);
    if(isNaN(roomNum)||roomNum<1||roomNum>10){ alert('Room tidak valid, masuk room 1'); roomNum=1; }
    roomId = 'room'+roomNum;
    const roomRef = db.ref('rooms/'+roomId);

    roomRef.once('value',snap=>{
        const data = snap.val();
        if(!data){
            // buat room baru
            roomRef.set({board:initBoard(), turn:'w', players:{white:uid}, chat:{}});
            myColor='w';
            statusEl.innerText='Menunggu lawan...';
        } else {
            const p = data.players||{};
            if(!p.white){ roomRef.child('players/white').set(uid); myColor='w'; }
            else if(!p.black){ roomRef.child('players/black').set(uid); myColor='b'; }
            else { myColor='spectator'; alert('Room penuh, masuk sebagai penonton'); }
        }
    });

    roomRef.on('value',snap=>{
        const data = snap.val(); if(!data) return;
        board = data.board||initBoard();
        turn = data.turn||'w';
        drawBoard();
        updateStatus();
        chatbox.innerHTML='';
        if(data.chat) Object.values(data.chat).forEach(msg=>{
            chatbox.innerHTML += `<div><b>${msg.user}:</b> ${msg.text}</div>`;
        });
        chatbox.scrollTop = chatbox.scrollHeight;
    });
}

// ====== INIT BOARD ======
function initBoard(){
    return [
        ['r','n','b','q','k','b','n','r'],
        ['p','p','p','p','p','p','p','p'],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['','','','','','','',''],
        ['P','P','P','P','P','P','P','P'],
        ['R','N','B','Q','K','B','N','R']
    ];
}

// ====== DRAW BOARD ======
function drawBoard(){
    boardEl.innerHTML='';
    board.forEach((row,r)=>{
        row.forEach((p,c)=>{
            const cell = document.createElement('div');
            cell.className = ((r+c)%2===0?'cell light':'cell dark');
            if(selected && selected[0]===r && selected[1]===c) cell.classList.add('selected');
            cell.innerText = p;
            cell.onclick = ()=>cellClick(r,c);
            boardEl.appendChild(cell);
        });
    });
}

// ====== CELL CLICK ======
function cellClick(r,c){
    if(myColor==='spectator') return;
    if(turn !== myColor) return;
    const piece = board[r][c];
    if(selected){
        movePiece(selected,[r,c]);
        selected=null;
        drawBoard();
    } else if(piece && ((myColor==='w' && piece===piece.toUpperCase()) || (myColor==='b' && piece===piece.toLowerCase()))){
        selected=[r,c];
        drawBoard();
    }
}

// ====== MOVE ======
function movePiece(from,to){
    const fr = from[0], fc=from[1], tr=to[0], tc=to[1];
    const piece = board[fr][fc];
    const target = board[tr][tc];
    if(target && ((myColor==='w' && target===target.toUpperCase())||(myColor==='b' && target===target.toLowerCase()))) return;
    board[tr][tc] = piece; board[fr][fc]='';
    turn = turn==='w'?'b':'w';
    db.ref('rooms/'+roomId).update({board,turn});
}

// ====== STATUS ======
function updateStatus(){
    if(myColor==='spectator'){ statusEl.innerText='Penonton'; return; }
    statusEl.innerText = 'Giliran '+(turn==='w'?'Putih':'Hitam') + (turn===myColor?' (kamu)':'');
}

// ====== CHAT ======
document.getElementById('sendChat').onclick=()=>{
    const text = chatInput.value.trim();
    if(!text) return;
    db.ref('rooms/'+roomId+'/chat').push({user:myName,text});
    chatInput.value='';
};

// ====== LOGOUT ======
document.getElementById('logoutBtn').onclick=()=>{
    auth.signOut().then(()=>location.reload());
};
</script>

</body>
</html>