<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catur Online – Realtime</title>

<style>
body { font-family:sans-serif; text-align:center; background:#121212; color:#fff; margin:0; padding:0; }
h2 { margin:20px 0; }
input, button { padding:10px; margin:5px; border-radius:6px; border:none; font-size:16px; }
button { background:#2ecc71; color:#000; font-weight:bold; cursor:pointer; }
#login, #game { max-width:400px; margin:auto; margin-top:20px; }
#board { display:grid; grid-template-columns:repeat(8,1fr); gap:2px; margin:20px auto; width:90vw; max-width:400px; }
.cell { width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size:24px; user-select:none; }
.white { background:#f0d9b5; }
.black { background:#b58863; }
.selected { outline:3px solid #ff5252; }
#status { margin:10px; font-weight:bold; }
#chatbox { max-width:400px; height:150px; background:#1e1e1e; margin:10px auto; overflow-y:auto; padding:5px; text-align:left; }
#chatInput { width:70%; }
#sendChat { width:25%; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h2>Catur Online – Realtime</h2>

<div id="login">
  <input id="nameInput" placeholder="Nama"><br>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password (min 6)"><br>
  <input id="roomInput" placeholder="Nomor Room (1-10)"><br>
  <button id="loginBtn">Masuk / Daftar & Join Room</button>
  <div id="loginError" style="color:red"></div>
</div>

<div id="game" style="display:none">
  <div id="profileBox"></div>
  <div id="status">Menunggu lawan...</div>
  <div id="board"></div>

  <div id="chatbox"></div>
  <input id="chatInput" placeholder="Chat...">
  <button id="sendChat">Kirim</button>

  <button onclick="logout()" style="background:#ff5252;color:white;margin-top:10px;">Logout</button>
</div>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyDnQwsg1aKKG38RjrPGoh5593eU6nO7Be4",
  authDomain: "catur2.firebaseapp.com",
  databaseURL: "https://catur2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "catur2",
  storageBucket: "catur2.appspot.com",
  messagingSenderId: "59572057774",
  appId: "1:59572057774:web:1e6426fa435811e8ea5f3f",
  measurementId: "G-QQ1WN6N31S"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

// ===== GLOBAL =====
let uid, myName, roomId, myColor='spectator', role='spectator';
let board=[], turn='w', selected=null;

// ===== DOM =====
const loginDiv = document.getElementById('login');
const gameDiv = document.getElementById('game');
const boardEl = document.getElementById('board');
const statusEl = document.getElementById('status');
const chatbox = document.getElementById('chatbox');
const chatInput = document.getElementById('chatInput');
const loginError = document.getElementById('loginError');
const profileBox = document.getElementById('profileBox');

// ===== LOGIN =====
document.getElementById('loginBtn').onclick = async ()=>{
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value.trim();
  const name = document.getElementById('nameInput').value.trim();
  const roomNum = parseInt(document.getElementById('roomInput').value);

  if(!email||!pass||!name||isNaN(roomNum)||roomNum<1||roomNum>10){
    loginError.textContent="Isi semua field dan nomor room 1-10";
    return;
  }

  try {
    const res = await auth.signInWithEmailAndPassword(email, pass);
    afterLogin(res.user, name, roomNum);
  } catch {
    try {
      const res = await auth.createUserWithEmailAndPassword(email, pass);
      afterLogin(res.user, name, roomNum);
    } catch(err){
      loginError.textContent = err.message;
    }
  }
};

function afterLogin(user,name,roomNum){
  uid = user.uid;
  myName = name;
  roomId = 'room'+roomNum;

  db.ref('users/'+uid).set({name:myName});
  loginDiv.style.display='none';
  gameDiv.style.display='block';
  profileBox.textContent = "Login sebagai: " + myName;

  joinRoom(roomId);
  listenChat();
}

// ===== ROOM =====
function joinRoom(roomId){
  const ref = db.ref('rooms/'+roomId+'/players');
  ref.once('value', snap=>{
    const players = snap.val()||{};
    if(!players.white){
      myColor='w'; role='player'; ref.child('white').set(uid);
    } else if(!players.black){
      myColor='b'; role='player'; ref.child('black').set(uid);
    } else {
      myColor='spectator'; role='spectator';
    }

    // init board if first player
    const boardRef = db.ref('rooms/'+roomId+'/board');
    boardRef.once('value', snap=>{
      if(!snap.exists()){
        boardRef.set(initBoard());
        db.ref('rooms/'+roomId+'/turn').set('w');
      }
    });

    listenRoom(roomId);
  });
}

function listenRoom(roomId){
  db.ref('rooms/'+roomId).on('value', snap=>{
    const data = snap.val();
    if(!data) return;
    board = data.board;
    turn = data.turn;
    drawBoard();
    if(turn==='w') statusEl.textContent = (myColor==='w'?'Giliran kamu':'Giliran lawan') 
                                        : (myColor==='b'?'Giliran kamu':'Giliran lawan');
  });
}

// ===== BOARD =====
function initBoard(){
  return [
    'r','n','b','q','k','b','n','r',
    'p','p','p','p','p','p','p','p',
    '','','','','','','','',
    '','','','','','','','',
    '','','','','','','','',
    '','','','','','','','',
    'P','P','P','P','P','P','P','P',
    'R','N','B','Q','K','B','N','R'
  ];
}

function drawBoard(){
  boardEl.innerHTML='';
  board.forEach((p,i)=>{
    const cell = document.createElement('div');
    const dark = (i + Math.floor(i/8)) % 2;
    cell.className = 'cell ' + (dark?'black':'white');
    if(i===selected) cell.classList.add('selected');
    cell.innerText = p;
    cell.onclick = ()=> clickCell(i);
    boardEl.appendChild(cell);
  });
}

// ===== MOVE =====
function isMine(p){
  return myColor==='w'? p===p.toUpperCase() : p===p.toLowerCase();
}

function clickCell(i){
  if(role!=='player') return;
  if(turn!==myColor) return;

  if(selected===i){ selected=null; drawBoard(); return; }
  if(selected===null){
    if(board[i] && isMine(board[i])) selected=i;
    return;
  }

  const piece = board[selected];
  if(movePiece(selected,i)){
    selected=null;
    turn = turn==='w'?'b':'w';
    db.ref('rooms/'+roomId+'/board').set(board);
    db.ref('rooms/'+roomId+'/turn').set(turn);
  } else {
    selected=null;
  }
  drawBoard();
}

function movePiece(f,t){
  const p = board[f];
  if(!p) return false;
  if(isMine(board[t])) return false;

  // hanya langkah pawn sederhana
  if(p.toLowerCase()==='p'){
    const dir = p==='P'?-8:8;
    if(t===f+dir && board[t]==='') return swap(f,t);
    if((t===f+dir-1 || t===f+dir+1) && board[t]!=='') return swap(f,t);
    if((p==='P' && f>=48 && t<8) || (p==='p' && f<16 && t>=56)) board[t] = p==='P'?'Q':'q', board[f]=''; return true;
    return false;
  }

  return swap(f,t);
}

function swap(f,t){ const tmp=board[t]; board[t]=board[f]; board[f]=''; return true; }

// ===== CHAT =====
document.getElementById('sendChat').onclick = sendChat;
function sendChat(){
  const txt = chatInput.value.trim();
  if(!txt) return;
  db.ref('rooms/'+roomId+'/chat').push({user:myName,text:txt,time:Date.now()});
  chatInput.value='';
}
function listenChat(){
  db.ref('rooms/'+roomId+'/chat').limitToLast(50).on('child_added', snap=>{
    const msg = snap.val();
    chatbox.innerHTML += `<b>${msg.user}:</b> ${msg.text}<br>`;
    chatbox.scrollTop = chatbox.scrollHeight;
  });
}

// ===== LOGOUT =====
function logout(){
  if(role==='player'){
    const playerKey = myColor==='w'?'white':'black';
    db.ref('rooms/'+roomId+'/players/'+playerKey).remove();
  }
  auth.signOut().then(()=>location.reload());
}
</script>

</body>
</html>